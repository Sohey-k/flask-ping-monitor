{% extends "base.html" %}

{% block title %}Ping実行 - Flask Ping Monitor{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Ping実行</h2>

        <!-- ホスト選択フォーム -->
        <div class="mb-6">
            <label class="block text-gray-700 font-bold mb-2">ホスト選択</label>
            <select id="hostSelect"
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">-- ホストを選択してください --</option>
                {% for host in hosts %}
                <option value="{{ host.ip_address }}" data-hostname="{{ host.hostname }}">
                    {{ host.hostname }} ({{ host.ip_address }})
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- 選択中の情報表示 -->
        <div id="selectedInfo" class="mb-6 hidden">
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
                <p class="text-sm text-gray-600">選択中のホスト</p>
                <p class="font-bold text-lg"><span id="selectedHostname"></span></p>
                <p class="text-gray-700">IPアドレス: <span id="selectedIp" class="font-mono"></span></p>
            </div>
        </div>

        <!-- Pingボタン -->
        <button id="pingButton" onclick="executePing()" disabled
            class="bg-blue-500 text-white font-bold py-3 px-8 rounded-md hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed transition duration-200">
            Ping実行 (5回)
        </button>

        <!-- ローディング表示 -->
        <div id="loading" class="hidden mt-6">
            <div class="flex items-center text-gray-600">
                <svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"
                        fill="none"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                Ping実行中...
            </div>
        </div>

        <!-- 結果表示 -->
        <div id="result" class="mt-6 hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-3">実行結果</h3>
            <div class="bg-gray-900 text-green-400 p-4 rounded-md overflow-x-auto">
                <pre id="output" class="text-sm font-mono whitespace-pre-wrap"></pre>
            </div>
        </div>

        <!-- エラー表示 -->
        <div id="error" class="mt-6 hidden">
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                <strong>エラー:</strong> <span id="errorMessage"></span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const hostSelect = document.getElementById('hostSelect');
    const pingButton = document.getElementById('pingButton');
    const selectedInfo = document.getElementById('selectedInfo');
    const selectedHostname = document.getElementById('selectedHostname');
    const selectedIp = document.getElementById('selectedIp');

    // ホスト選択時の処理
    hostSelect.addEventListener('change', function () {
        const selectedOption = this.options[this.selectedIndex];

        if (this.value) {
            selectedHostname.textContent = selectedOption.dataset.hostname;
            selectedIp.textContent = this.value;
            selectedInfo.classList.remove('hidden');
            pingButton.disabled = false;
        } else {
            selectedInfo.classList.add('hidden');
            pingButton.disabled = true;
        }

        // 前回の結果をクリア
        document.getElementById('result').classList.add('hidden');
        document.getElementById('error').classList.add('hidden');
    });

    // Ping実行
    async function executePing() {
        const ipAddress = hostSelect.value;

        if (!ipAddress) {
            showError('ホストを選択してください');
            return;
        }

        // UI更新
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('result').classList.add('hidden');
        document.getElementById('error').classList.add('hidden');
        pingButton.disabled = true;

        try {
            const response = await fetch('/ping', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ ip_address: ipAddress })
            });

            const data = await response.json();
            document.getElementById('loading').classList.add('hidden');
            pingButton.disabled = false;

            if (data.success) {
                document.getElementById('output').textContent = data.output;
                document.getElementById('result').classList.remove('hidden');
            } else {
                showError(data.error);
            }
        } catch (error) {
            document.getElementById('loading').classList.add('hidden');
            pingButton.disabled = false;
            showError('通信エラーが発生しました');
        }
    }

    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('error').classList.remove('hidden');
    }
</script>
{% endblock %}